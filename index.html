<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>SPAN Diagram v4.8</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{overflow-x:hidden;position:relative;width:100%;height:100vh}body{font-family:'Graphik',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f8f9fa;min-height:100vh;padding:10px;color:#2c3e50;position:relative;overflow-x:hidden}.ct{max-width:1400px;margin:0 auto;background:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);overflow:hidden;display:flex;flex-direction:column;min-height:100vh;position:relative}.h{background:#fff;color:#2c3e50;padding:20px;text-align:center;border-bottom:1px solid #e9ecef}.h p{font-size:.9rem;opacity:.7;font-weight:300;margin:0}.ctrl{padding:15px 40px;background:#f8f9fa;border-bottom:1px solid #e9ecef;text-align:center;display:flex;justify-content:center;align-items:center;gap:15px;flex-wrap:wrap}.mc{display:flex;min-height:700px;flex:1;overflow:visible;position:relative}.cp{width:300px;background:#f8f9fa;border-right:2px solid #e9ecef;padding:15px;display:flex;flex-direction:column;overflow-y:visible;flex-shrink:0;height:auto;min-height:600px}.ct1{font:bold 1.2rem sans-serif;color:#2c3e50;margin-bottom:10px;text-align:center}.cg{display:grid;grid-template-columns:1fr 1fr;gap:8px;width:100%;padding-bottom:10px}.c{width:100%;height:80px;background:#fff;border-radius:10px;cursor:grab;box-shadow:0 4px 6px rgba(0,0,0,.1);transition:all .3s ease;border:3px solid #3498db;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:6px;user-select:none;position:relative;z-index:10}.c.dragging{opacity:.5;transform:scale(.95)}.c:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,.15);border-color:#2980b9}.c:active{cursor:grabbing}.i{width:28px;height:28px;margin-bottom:4px;display:flex;align-items:center;justify-content:center}.i img{width:100%;height:100%;object-fit:contain;pointer-events:none}.n{font-weight:600;color:#2c3e50;font-size:.75rem;line-height:1.2}.da{flex:1;padding:20px;background:#fafbfc;position:relative;min-height:calc(100vh - 350px);overflow:hidden;margin-top:20px}.dz{width:calc(100% - 40px);height:calc(100% - 40px);min-height:calc(100vh - 400px);max-height:none;border:3px dashed #bdc3c7;border-radius:15px;position:relative;background:rgba(255,255,255,.9);transition:all .3s ease;overflow:auto;display:block;box-shadow:inset 0 0 10px rgba(0,0,0,.05);margin:20px}.dz.drag-over{border-color:#3498db;background:rgba(52,152,219,.1);transform:scale(1.01)}.dzt{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#7f8c8d;font:300 1.5rem sans-serif;text-align:center;pointer-events:none;width:90%;max-width:300px;z-index:0}.d{position:absolute;width:auto;height:auto;cursor:move;user-select:none;transition:all .3s ease;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:0;z-index:2}.d[data-type^=s]{justify-content:flex-start}.d:hover{transform:scale(1.05)}.d.connecting{filter:drop-shadow(0 0 20px rgba(231,76,60,.5))}.d .i{width:100px;height:100px;margin-bottom:10px;background:#e8f0fe;border-radius:50%;display:flex;align-items:center;justify-content:center;padding:25px;position:relative}.d:not([data-type="grid"]):not([data-type="solar"]):not([data-type="battery"]):not([data-type="gen"]) .i{width:auto;height:auto;max-width:140px;background:transparent;border-radius:8px;padding:0;border:none;margin-bottom:5px}.d[data-type^=s] .i{max-width:240px}.d .i img{width:100%;height:100%;object-fit:contain;pointer-events:none;user-select:none}.d .n{font-size:1rem;font-weight:600;line-height:1.2;color:#2c3e50;margin-bottom:5px;text-align:center}.d[data-type^=l] .n{max-width:80px;margin:0;word-break:break-word;line-height:1.1}.d[data-type=s1] .n,.d[data-type=s2] .n,.d[data-type=s3] .n,.d[data-type=s4] .n,.d[data-type=s5] .n,.d[data-type=m1] .n,.d[data-type=p1] .n,.d[data-type=p2] .n,.d[data-type=p3] .n,.d[data-type=p4] .n,.d[data-type=g4] .n,.d[data-type=e1] .n,.d[data-type=e2] .n{margin:5px 0 0}.r{position:absolute;top:-5px;right:-5px;background:#fff;color:#2c3e50;border:2px solid #2c3e50;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 4px rgba(0,0,0,.1);z-index:10}.r:hover{background:#f8f9fa;transform:scale(1.1)}.d[data-type=rm] .r{right:15px}.b{padding:8px 18px;margin:0;border:2px solid #2c3e50;border-radius:30px;cursor:pointer;font-size:.9rem;font-weight:500;transition:all .2s ease;white-space:nowrap;background:transparent;color:#2c3e50}.b:hover{background:#f1f3f5;transform:translateY(-1px)}.b.active{background:#2c3e50;color:#fff}.mi{display:inline-block;padding:8px 18px;margin:0;background:transparent;color:#2c3e50;border:2px solid #2c3e50;border-radius:30px;font-size:.9rem;font-weight:500;min-width:240px;text-align:center}.mi.active{background:#2c3e50;color:#fff}.rp{position:fixed;right:20px;top:180px;width:200px;background:#fff;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.15);padding:12px;z-index:100;border:2px solid #e9ecef;max-height:300px;overflow-y:auto}.rp h3{margin:0 0 8px;color:#2c3e50;font-size:.9rem;font-weight:600;padding-bottom:6px;border-bottom:1px solid #e9ecef}.ri{margin-bottom:6px;padding:4px 8px;background:#f8f9fa;border-radius:4px;font-size:.75rem;line-height:1.2}.ri strong{color:#2c3e50;display:inline-block;margin-right:5px}.ri .yes{color:#27ae60;font-weight:600}.ri .no{color:#e74c3c;font-weight:600}.cr{position:absolute;top:15px;right:15px;width:24px;height:24px;border:none;background:#f8f9fa;border-radius:50%;cursor:pointer;font-size:16px;color:#7f8c8d;display:flex;align-items:center;justify-content:center;transition:all .2s}.cr:hover{background:#e9ecef;color:#2c3e50}#pd,#pn,#pd.tall,#pn.tall{bottom:calc(170px + var(--extra-height,0px))}.ch{font-size:.9rem;font-weight:bold;color:#2c3e50;margin:15px 0 8px;text-align:center;border-bottom:1px solid #e9ecef;padding-bottom:5px;grid-column:1/-1}</style>
</head>
<body><div class="ct"><div class="h"><img src="https://cdn.prod.website-files.com/62e15afb0ead4bad92750d3a/62e15afb0ead4bcd05750e09_span-logo-r.svg" alt="SPAN" style="height:40px;margin-bottom:5px"><p>Electrical Diagram Builder</p></div><div class="ctrl"><span class="mi active" id="mI">Move Mode</span><button class="b" id="cB" onclick="tCM()">Connect Mode</button><button class="b" onclick="cCn()">Clear Lines</button><button class="b" onclick="shareConfig()">Share Configuration</button></div><div class="mc"><div class="cp"><div class="ct1">Electrical Components</div><div class="cg" id="cG"></div></div><div class="da"><div class="dz" id="dZ"><svg class="connection-lines" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1"></svg><div class="dzt">Drag components here to build your electrical diagram</div></div></div></div></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
let dE,ct=0,dC=[],cn=[],cM,fS,uT;
const U='https://cdn.prod.website-files.com/62e15afb0ead4bad92750d3a/',dZ=document.getElementById('dZ'),
F=['6889475aa7993f43caa8cef9_669841eb744bc23bcfabeb96c1399124_grid.png','6889475a382349f0125b717c_1bb942224ef34efdfd4b206670deab25_solar.png','6889475a6cae641f99879fc4_a2cc088d470ed8c72d0286c7d25b3cc5_battery.png','6894d3562638f83e90ea0a60_caf26997926d70e5cf23899026601488_generator.png','6889659327f664eb41349c4d_060c5ea1d974c924292b99e4906f0296_meter.png','6892884deada840b398f0fd7_3fc93bab898bf82129391a123afde924_meter_main_cx.png','6894f17a47217a68749cdae5_main_disco200.png','6892884d0b950e121ff394e0_1716f5db429a443aa81baf6cb195afec_nonSpan_main_cx.png','68a54474baad418a9147d3ce_aa73ddf6bc05e64f658f2bd85fd00013_nonspansub.png','6893a9c68603560e353610e8_d5520024bed45f1cb4a419950b2a2731_span16_large.png','6893a9c6bde013c8262063c4_span24_large.png','6892884d154273ffb72379ed_0fb0883aac3ee2c82c4504e9f5fd3e5f_span32_cx.png','6893c6707fa9b20579e6d5dd_de0688281499862b5660eb526cc0fcf2_span40.png','6893c6709faeddbe475089c4_span48.png','6889680ce1e306969db05dc3_09bf908bce8e902f7ff9fedf099e91f9_mid.png','6889475a8abf28b5a1ce44bb_97ef997ca91c1b08ddf1a9f376ad222d_house_loads.png','6892884d656af3683d380984_2bd928df35e116d610a2147c7581dd26_drive_cx.png','6894f088a6d0642c9965630c_maindisco.png','68a275cb04ce983f5aa53b7f_ATS_wbreakers.png','6896493b2f08ba4d92272efb_259520114a9a58b4939c84e46330a1d6_ats.png','68a35934d4d1baa2ab465e51_7af3fdd9a6d4c8400d548454f94459d0_remote_metericon.png','689767cd4ca7b1244ae6084e_enphase_gate.png','689767cd8853e160388583a3_franklin_gate.png','689767cdbd1c24ee0272f81e_tesla_gate.png','689767cd265d27ca070f68e8_solarEdge_gate.png'],
cD=[['grid',0,'Grid'],['solar',1,'Solar'],['battery',2,'Battery'],['gen',3,'Generator'],['meter',4,'Meter'],['m1',5,'Meter Main'],['m2',6,'Main Service','Disconnect'],['p1',7,'Non-SPAN','Main'],['p2',8,'Non-SPAN','Sub'],['s1',9,'SPAN 16'],['s2',10,'SPAN 24'],['s3',11,'SPAN 32'],['s4',12,'SPAN 40'],['s5',13,'SPAN 48'],['p3',14,'M.I.D.'],['l1',15,'House Loads'],['l2',15,'Upstream Loads'],['l3',15,'Garage Loads'],['l4',15,'ADU Loads'],['e1',16,'SPAN Drive'],['e2',16,'Other EVSE'],['p4',17,'Main Disconnect','(Ext)'],['ats',18,'ATS'],['mts',19,'MTS'],['rm',20,'Remote Meter Kit'],['gw1',21,'Enphase','IQ Controller'],['gw2',22,'Franklin aGate'],['gw3',23,'Tesla Gateway'],['gw4',24,'SolarEdge','Gateway']],
cI={};cD.forEach(([t,i])=>cI[t]=U+F[i]);
const aR=[100,125,150,200];

const sT=['s1','s2','s3','s4','s5'],pT=[...sT,'p1','m1','p3','p4','m2','gw2','gw3','gw4','p2'],lT=['l1','l2','l3','l4'],mT=['meter','m1','m2'],gT=['gw1','gw2','gw3','gw4'],aT=['ats','mts'],bT=['m1','p1','p3','p2','p4','m2',...gT,'e1','e2'],lA=[...sT,'p1','m1','p3','p2','p4','m2',...gT],sC=['meter','m1','m2','p4','solar','battery','l2','p1','p3','p2',...gT,'l1','l3','l4','e1','e2'],
D=document,W=window,M=Math,S='style',L='left',T='top',P='position',A='absolute',R='relative',N='none',B='block',Z='.d',E='.i',I='img',G=t=>D.getElementById(t),Q=t=>D.querySelector(t),QA=t=>D.querySelectorAll(t),CE=t=>D.createElement(t),AE=(e,t,f)=>e.addEventListener(t,f),gR=e=>e.getBoundingClientRect(),pI=t=>parseInt(t)||0;
function gC(t,i,n,s){return'<div class="c" draggable="true" data-type="'+t+'"><div class="i"><img src="'+U+F[i]+'" alt="'+t+'"></div><div class="n">'+n+(s?'<br><span style="font-size:'+(s.includes('IQ')?'.65rem':'.7rem')+';font-weight:'+(s.includes('IQ')?'600':'400')+'">'+s+'</span>':'')+'</div></div>'}
function gCH(h){return'<div class="ch">'+h+'</div>'}
['dragover','drop','dragenter','dragleave'].forEach((e,i)=>AE(dZ,e,[hDO,hD,hDE,hDL][i]));
function uCD(){if(uT)cancelAnimationFrame(uT);uT=requestAnimationFrame(()=>uC())}
function aPD(){const disc=CE('div');disc.id='disclaimer';disc[S].cssText=`${P}:${A};${L}:20px;bottom:20px;width:200px;height:150px;border:2px solid #2c3e50;background:#fff;border-radius:8px;padding:8px;font-size:10px;z-index:5;text-align:center`;disc.innerHTML='<img src="'+U+'62e15afb0ead4bcd05750e09_span-logo-r.svg" style="height:25px;margin-bottom:8px"><div style="font-size:9px;line-height:1.2;text-align:left">This tool is intended as a preliminary guide only. You are responsible for ensuring your final product selection meets local code requirements and aligns with your customer\'s specific needs. If you have any questions, please contact your SPAN sales representative or email support@span.io</div>';dZ.appendChild(disc);const pd=CE('div');pd.id='pd';pd[S].cssText=`${P}:${A};${L}:240px;bottom:20px;width:250px;height:150px;border:2px solid #2c3e50;background:#fff;border-radius:8px;padding:8px;font-size:12px;z-index:5`;pd.innerHTML='<div style="font-weight:bold;margin-bottom:5px">Project Details</div><textarea id="dt" style="width:100%;height:105px;border:none;resize:none;font-size:11px;overflow:hidden;margin-top:2px" placeholder="Enter project details..."></textarea>';dZ.appendChild(pd);const notes=CE('div');notes.id='pn';notes[S].cssText=`${P}:${A};${L}:510px;bottom:20px;right:20px;height:150px;border:2px solid #2c3e50;background:#fff;border-radius:8px;padding:8px;font-size:12px;z-index:5`;notes.innerHTML='<div style="font-weight:bold;margin-bottom:5px">Notes</div><textarea id="nt" style="width:100%;height:105px;border:none;resize:none;font-size:11px;overflow:hidden;margin-top:2px" placeholder="Enter notes..."></textarea>';dZ.appendChild(notes);function aR(el,box){el[S].height='105px';const h=M.max(105,el.scrollHeight);el[S].height=h+'px';box[S].height=(h+45)+'px'}const dt=G('dt'),nt=G('nt');dt.oninput=()=>{aR(dt,pd);const extraH=Math.max(0,dt.scrollHeight-105);pd.style.setProperty('--extra-height',extraH+'px');if(extraH>0)pd.classList.add('tall')};nt.oninput=()=>{aR(nt,notes);const extraH=Math.max(0,nt.scrollHeight-105);notes.style.setProperty('--extra-height',extraH+'px');if(extraH>0)notes.classList.add('tall')}}
function uDZS(){let x=0,y=0;dC.forEach(c=>{const e=G(c.id);if(e){const r=gR(e),d=gR(dZ),rx=r.right-d[L],ry=r.bottom-d[T];x=M.max(x,rx);y=M.max(y,ry)}});if(x>0||y>0)dZ[S].minWidth=M.max(dZ.parentElement.clientWidth-40,x+100)+'px'}
function hDS(e){if(cM){e.preventDefault();return}dE=e.target;e.dataTransfer.effectAllowed='copy';e.target[S].opacity='.5'}
function hDO(e){e.preventDefault();e.dataTransfer.dropEffect='copy'}
function hDE(e){if(!cM){e.preventDefault();dZ.classList.add('drag-over')}}
function hDL(e){if(!dZ.contains(e.relatedTarget))dZ.classList.remove('drag-over')}
function hD(e){e.preventDefault();dZ.classList.remove('drag-over');if(dE&&!cM){const r=gR(dZ),x=e.clientX-r[L],y=e.clientY-r[T];cDC(dE,x,y);dE[S].opacity='1';dE=null}}
function cDC(o,x,y){ct++;const d=CE('div'),t=o.dataset.type,m=W.innerWidth<=768,oX=m?32:96,oY=m?32:120,nX=m?30:50,nY=m?30:50,sp=[...sT,...bT,...lT].includes(t);d.className=Z.slice(1);d[S][L]=(x-(sp?oX:nX))+'px';d[S][T]=(y-(sp?oY:nY))+'px';d.id='c'+ct;d.dataset.type=t;const i=CE('div'),n=o.querySelector('.n').cloneNode(true),b=CE('button'),s=cI[t];i.className=E.slice(1);if(s)i.innerHTML='<img src="'+s+'" alt="'+t+'" draggable="false">';const nm={'s1':['SPAN 16','MAIN 16'],'s4':['SPAN 40','MAIN 40'],'s5':['SPAN 48','MLO 48'],'s2':['SPAN 24','MLO 24'],'s3':['SPAN 32','MAIN 32']};if(nm[t]){n.innerHTML=n.innerHTML.replace(nm[t][0],nm[t][1]);if(['s1','s3','s4'].includes(t)){d.amperage=100;const aS=CE('div');const idx=aR.indexOf(d.amperage);
aS.textContent=(idx>0?'◄ ':'')+d.amperage+'A'+(idx<aR.length-1?' ►':'');aS.style.cssText='font-size:0.8rem;color:#2c3e50;margin-top:2px;cursor:pointer;font-weight:bold;border:1px solid #ddd;padding:2px 6px;border-radius:3px;background:#f8f9fa';n.appendChild(aS)}}b.className='r';b.innerHTML='×';b.onclick=()=>rC(d.id);if(sp){i.appendChild(b);d.appendChild(i);d.appendChild(n)}else{d.appendChild(i);d.appendChild(n);d.appendChild(b)}AE(d,'mousedown',hCMD);AE(d,'click',hCC);if(['s1','s3','s4'].includes(t))AE(d,'click',e=>{if(!cM&&e.target.style.cursor==='pointer'){e.stopPropagation();const cI=aR.indexOf(d.amperage);const rect=e.target.getBoundingClientRect();const clickX=e.clientX-rect.left;const isLeftHalf=clickX<rect.width/2;if(isLeftHalf&&cI>0){d.amperage=aR[cI-1]}else if(!isLeftHalf&&cI<aR.length-1){d.amperage=aR[cI+1]}const idx=aR.indexOf(d.amperage);
e.target.textContent=(idx>0?'◄ ':'')+d.amperage+'A'+(idx<aR.length-1?' ►':'');}});dZ.appendChild(d);dC.push({id:d.id,type:t,x,y});if(dC.length===1){Q('.dzt')[S].display=N;aPD()}uDZS();uC()}
function hCMD(e){const c=e.target.closest(Z);if(!c||e.target.classList.contains('r')||cM)return;e.preventDefault();e.stopPropagation();const l=pI(c[S][L]),t=pI(c[S][T]),sx=e.clientX,sy=e.clientY;let cl=null,lx=0,ly=0,cl2=null,lx2=0,ly2=0,cl3=null,lx3=0,ly3=0;const cT=c.dataset.type,gCC=(tp,id)=>{cn.forEach(n=>{if(n.type===tp){const hid=n.from===id?n.to:n.to===id?n.from:null;if(hid){const h=G(hid);if(h&&((tp==='h'&&h.dataset.type==='l1')||(tp==='t'&&aT.includes(h.dataset.type))||(tp==='n'&&(h.dataset.type==='gen'||h.dataset.type==='m1'))||(tp==='u'&&h.dataset.type==='l2'))){if(!cl){cl=h;lx=pI(h[S][L])-l;ly=pI(h[S][T])-t}else if(!cl2){cl2=h;lx2=pI(h[S][L])-l;ly2=pI(h[S][T])-t}else{cl3=h;lx3=pI(h[S][L])-l;ly3=pI(h[S][T])-t}}}}})};if(sT.includes(cT)){gCC('h',c.id);gCC('t',c.id)}if(bT.slice(0,9).includes(cT))gCC('u',c.id);if(aT.includes(cT)){gCC('t',c.id);gCC('n',c.id)}c[S].zIndex=1000;c[S].cursor='grabbing';if(cl)cl[S].zIndex=999;if(cl2)cl2[S].zIndex=998;if(cl3)cl3[S].zIndex=997;function mM(e){const dx=e.clientX-sx,dy=e.clientY-sy;let nl=M.max(0,M.min(l+dx,dZ.clientWidth-100)),nt=M.max(0,M.min(t+dy,dZ.clientHeight-130));c[S][L]=nl+'px';c[S][T]=nt+'px';if(cl){cl[S][L]=(nl+lx)+'px';cl[S][T]=(nt+ly)+'px'}if(cl2){cl2[S][L]=(nl+lx2)+'px';cl2[S][T]=(nt+ly2)+'px'}if(cl3){cl3[S][L]=(nl+lx3)+'px';cl3[S][T]=(nt+ly3)+'px'}uCD()}function mU(){D.removeEventListener('mousemove',mM);D.removeEventListener('mouseup',mU);c[S].zIndex='';c[S].cursor='move';if(cl)cl[S].zIndex='';if(cl2)cl2[S].zIndex='';if(cl3)cl3[S].zIndex='';uC();uDZS()}AE(D,'mousemove',mM);AE(D,'mouseup',mU)}
function hCn(c){if(!fS){fS=c;c.classList.add('connecting')}else if(fS===c){fS.classList.remove('connecting');fS=null}else{cC(fS,c);fS.classList.remove('connecting');fS=null}}
function hCC(e){if(cM){e.preventDefault();e.stopPropagation();const c=e.target.closest(Z);if(c)hCn(c)}}
function sN(c,m,b='#ff6b6b'){const n=CE('div');n[S].cssText=`${P}:${A};background:${b};color:#fff;padding:10px 15px;border-radius:5px;font-size:14px;font-weight:500;box-shadow:0 2px 10px rgba(0,0,0,.2);z-index:1000;max-width:300px;word-wrap:break-word;line-height:1.4`;n.textContent=m;const r=gR(c),dr=gR(dZ),cX=r[L]+r.width/2-dr[L],cY=r[T]-dr[T]-50,nW=300,nH=60,pX=M.min(M.max(10,cX-nW/2),dr.width-nW-10),pY=M.max(10,cY);if(pY<10){n[S][T]=(r[T]+r.height-dr[T]+10)+'px';n[S][L]=pX+'px'}else{n[S][T]=pY+'px';n[S][L]=pX+'px'}dZ.appendChild(n);setTimeout(()=>{n[S].transition='opacity .5s';n[S].opacity='0';setTimeout(()=>n.remove(),500)},5000)}
function cC(c1,c2){const t1=c1.dataset.type,t2=c2.dataset.type,X='Invalid connection',vR={grid:mT,e1:sT,gen:['grid','meter','m1','m2','p4','solar','battery','l1','l2','l3','l4','e1','e2','s1','s2','s3','s4','s5','p1','p2','p3','gw1','gw2','gw3','gw4','ats','mts','rm'],'l1':lA,'l2':lA,'l3':lA,'l4':lA,'e2':[...pT,'p2'],solar:lA,battery:lA,meter:['grid','meter','m2','p4',...aT,...gT,'l2','s3','s1','s4','p1','m1','p3','p4','m2',...gT],'m2':['grid',...mT,'p4',...aT,...gT,'l2',...pT,'battery'],'m1':['grid',...mT,'p4',...aT,...gT,'l2',...pT,'battery'],'p4':['meter','m2','p4',...aT,'l2',...pT,'battery'],ats:['grid','meter','m1','m2','p4','solar','battery','l1','l2','l3','l4','e1','e2','s1','s2','s3','s4','s5','p1','p2','p3','gw1','gw2','gw3','gw4','ats','mts','rm','gen'],mts:['grid','meter','m1','m2','p4','solar','battery','l1','l2','l3','l4','e1','e2','s1','s2','s3','s4','s5','p1','p2','p3','gw1','gw2','gw3','gw4','ats','mts','rm','gen'],'p3':['meter','m1','m2','p4','solar','battery','l2',...sT,'p1',...gT],'s1':[...sC,'ats','mts','s1','s2','s4','s5'],'s3':[...sC,'ats','mts','s3','rm'],'s2':[...sC,'s1','s2','s4','s5'],'s4':[...sC,'ats','mts','s1','s2','s4','s5'],'s5':[...sC,'s1','s2','s4','s5'],'gw1':['solar','battery','meter','m1','l2','rm','p4','p2','p1'],'gw2':['solar','battery','meter','m1','l2','s1','s2','s3','s4','s5','p1','p3','p4','gw2','gw3','gw4','p2','ats','mts','gen'],'gw3':['solar','battery','meter','m1','l2','s1','s2','s3','s4','s5','p1','p3','p4','gw2','gw3','gw4','p2','ats','mts','gen'],'gw4':['solar','battery','meter','m1','l2','s3','ats','mts','p4','p2','p1'],'rm':['s3','gw1'],'p2':[...sT,'meter','m1','m2','p4','solar','battery','l2','p1','p3',...gT,'e1','e2','l1','l3','l4']},vM={grid:'Grid → Meter only',e1:'Drive → SPAN only',gen:'Generator connects to anything','l1':'Loads → panels only','l2':'Loads → panels only','l3':'Loads → panels only','l4':'Loads → panels only','e2':'EVSE → panel only',solar:'Solar → gateways/panels',battery:'Battery → gateways/panels',meter:X,'m2':X,'p4':X,ats:'ATS connects to anything',mts:'MTS connects to anything','p3':'M.I.D. → no ATS/MTS','gw1':'Enphase → Remote Meter → SPAN 32 only','gw2':'Invalid Connection','gw3':'Invalid Connection','gw4':'Invalid Connection','rm':'Enphase → Remote Meter → SPAN 32 only','p2':'Non-SPAN sub → panels only','s1':'SPAN 16 → Enphase needs SPAN 32','s2':'SPAN 24 → Enphase needs SPAN 32','s4':'SPAN 40 → Enphase needs SPAN 32','s5':'SPAN 48 → Enphase needs SPAN 32'},cL={'e1':'#cc9900',gen:'#ff9900','l1':'#f60','l2':'#f60','l3':'#f60','l4':'#f60','e2':'#f30',meter:'#93f','m2':'#93f','p4':'#93f',ats:'#09c',mts:'#09c','gw1':'#fc0','gw2':'#0c9','gw3':'#0c9','gw4':'#fc0',solar:'#fc0',battery:'#6c0','p3':'#f60'};if((t1==='gen'&&sT.includes(t2))||(t2==='gen'&&sT.includes(t1))){const gen=t1==='gen'?c1:c2;sN(gen,'Generator → ATS/MTS → SPAN','#ff9900');return}chkM=(c,t,sp,c1,c2)=>{if(mT.includes(t)&&sT.includes(sp)){const mC=cn.filter(n=>n.from===c.id||n.to===c.id),hA=mC.some(n=>{const oId=n.from===c.id?n.to:n.from,o=G(oId);return o&&aT.includes(o.dataset.type)});if(hA){const aC=mC.find(n=>{const oId=n.from===c.id?n.to:n.from,o=G(oId);return o&&aT.includes(o.dataset.type)});if(aC){const aId=aC.from===c.id?aC.to:aC.from,a=G(aId),sP=c===c1?c2:c1,eC=cn.find(n=>(n.from===aId&&n.to===sP.id)||(n.to===aId&&n.from===sP.id));if(!eC){const nId=aId+'-'+sP.id;cn.push({id:nId,from:aId,to:sP.id,type:'t'});const sr=gR(sP),si=sP.querySelector(E),sir=si?gR(si):sr,nl=pI(sP[S][L])-150,st=pI(sP[S][T]),sh=sr.height,th=130,nt=st+(sh/2)-(th/2);a[S][L]=nl+'px';a[S][T]=nt+'px';sN(a,'Meter rerouted via ATS','#0c0')}else sN(c,'Only ATS/MTS allowed when generator present','#93f');return true}sN(c,'Only ATS/MTS allowed with generator','#93f');return true}const sPC=cn.filter(n=>n.from===(c===c1?c2.id:c1.id)||n.to===(c===c1?c2.id:c1.id)),sHA=sPC.some(n=>{const oId=n.from===(c===c1?c2.id:c1.id)?n.to:n.from,o=G(oId);return o&&aT.includes(o.dataset.type)});if(sHA){sN(c,'Grid requires ATS/MTS with generator','#93f');return true}}return false};if((t1==='s3'&&['s1','s2','s4','s5'].includes(t2))||(t2==='s3'&&['s1','s2','s4','s5'].includes(t1))){const sp32=t1==='s3'?c1:c2;sN(sp32,'SPAN 32 cannot connect to other SPAN panels','#f90');return}if((t1==='meter'&&['s5','s2'].includes(t2))||(t2==='meter'&&['s5','s2'].includes(t1))){const mlo=(['s5','s2'].includes(t1))?c1:c2;sN(mlo,'MLO panels need upstream protection','#f6b');return}if((aT.includes(t1)&&['s5','s2'].includes(t2))||(aT.includes(t2)&&['s5','s2'].includes(t1))){const mlo=(['s5','s2'].includes(t1))?c1:c2;sN(mlo,'MLO panels cannot connect to ATS/MTS','#f6b');return}for(let t of[t1,t2]){if(vR[t]){const o=t===t1?t2:t1;if(!vR[t].includes(o)){if((t==='gw1'||t==='gw4')&&pT.includes(o)&&o!=='s3'&&o!=='p4'&&o!=='p1'){const msg=t==='gw1'?'Enphase → Remote Meter → SPAN 32 only':'SolarEdge → SPAN 32 only';sN(t===t1?c1:c2,msg,'#fc0');return}sN(t===t1?c1:c2,vM[t],cL[t]||'#f6b');return}}}if(t1==='e2'||t2==='e2'){const ec=t1==='e2'?c1:c2;if(cn.filter(n=>n.from===ec.id||n.to===ec.id).length>0){sN(ec,'EVSE: one connection only','#f30');return}}const cid=c1.id+'-'+c2.id;if(cn.find(n=>n.id===cid||n.id===c2.id+'-'+c1.id))return;if((aT.includes(t1)&&mT.includes(t2))||(aT.includes(t2)&&mT.includes(t1))){const a=aT.includes(t1)?c1:c2,m=mT.includes(t1)?c1:c2,mC=cn.filter(n=>n.from===m.id||n.to===m.id),sConn=mC.find(n=>{const oId=n.from===m.id?n.to:n.from,o=G(oId);return o&&sT.includes(o.dataset.type)});if(sConn){const sId=sConn.from===m.id?sConn.to:sConn.from,sP=G(sId);cn=cn.filter(n=>n.id!==sConn.id);const nId=a.id+'-'+sId;if(!cn.some(n=>n.id===nId||n.id===sId+'-'+a.id)){cn.push({id:nId,from:a.id,to:sId,type:'t'});const sr=gR(sP),si=sP.querySelector(E),sir=si?gR(si):sr,nl=pI(sP[S][L])-150,st=pI(sP[S][T]),sh=sr.height,th=130,nt=st+(sh/2)-(th/2);a[S][L]=nl+'px';a[S][T]=nt+'px';const g=Array.from(QA(Z)).find(e=>e.dataset.type==='gen');if(g&&!cn.some(n=>(n.from===g.id&&n.to===a.id)||(n.to===g.id&&n.from===a.id))){g[S][L]=nl+'px';g[S][T]=(nt+150)+'px';const gc=g.id+'-'+a.id;cn.push({id:gc,from:g.id,to:a.id,type:'n'})}sN(a,'Meter-SPAN connection rerouted through '+(a.dataset.type==='ats'?'ATS':'MTS'),'#0c0')}const nc={id:cid,from:c1.id,to:c2.id,type:'n'};cn.push(nc);uDZS();uC();return}}const hl=(t1==='l1'&&sT.includes(t2))||(t2==='l1'&&sT.includes(t1)),ul=(t1==='l2'&&bT.slice(0,9).includes(t2))||(t2==='l2'&&bT.slice(0,9).includes(t1)),ts=false;if(hl){const h=t1==='l1'?c1:c2,s=t1==='l1'?c2:c1,sr=gR(s),si=s.querySelector(E),sir=si?gR(si):sr,nl=pI(s[S][L])+(sir.width||140)+10,st=pI(s[S][T]),sh=sr.height,hh=130,vo=s.dataset.type==='s2'?-10:10,nt=st+(sh/2)-(hh/2)+vo;h[S][L]=nl+'px';h[S][T]=nt+'px'}if(ul){const u=t1==='l2'?c1:c2,p=t1==='l2'?c2:c1,pr=gR(p),pi=p.querySelector(E),pir=pi?gR(pi):pr,nl=pI(p[S][L])+(pir.width||100)+10,pt=pI(p[S][T]),ph=pr.height,uh=130,nt=pt+(ph/2)-(uh/2)+10;u[S][L]=nl+'px';u[S][T]=nt+'px'}if(ts){const t=aT.includes(t1)?c1:c2,sp=aT.includes(t1)?c2:c1,sr=gR(sp),si=sp.querySelector(E),sir=si?gR(si):sr,nl=pI(sp[S][L])-150,st=pI(sp[S][T]),sh=sr.height,th=130,nt=st+(sh/2)-(th/2);t[S][L]=nl+'px';t[S][T]=nt+'px';const eM=cn.filter(n=>{const iS=(n.from===sp.id||n.to===sp.id);if(!iS)return false;const oId=n.from===sp.id?n.to:n.from,o=G(oId);return o&&mT.includes(o.dataset.type)});if(eM.length>0){eM.forEach(c=>{const mId=c.from===sp.id?c.to:c.from,m=G(mId);if(m){cn=cn.filter(n=>n.id!==c.id);const nId=mId+'-'+t.id;if(!cn.some(n=>n.id===nId||n.id===t.id+'-'+mId))cn.push({id:nId,from:mId,to:t.id,type:'n'})}});sN(t,'Meter rerouted through '+(t.dataset.type==='ats'?'ATS':'MTS'),'#0c0')}const g=Array.from(QA(Z)).find(e=>e.dataset.type==='gen');if(g&&!cn.some(n=>(n.from===g.id&&n.to===t.id)||(n.to===g.id&&n.from===t.id))){g[S][L]=nl+'px';g[S][T]=(nt+150)+'px';const gc=g.id+'-'+t.id;cn.push({id:gc,from:g.id,to:t.id,type:'n'})}}const nc={id:cid,from:c1.id,to:c2.id,type:hl?'h':ul?'u':ts?'t':'n'};cn.push(nc);uDZS();if(['h','u','t'].includes(nc.type))setTimeout(()=>uC(),200);else uC()}
function uC(){const s=Q('.connection-lines'),H='http://www.w3.org/2000/svg';s.innerHTML='';let mX=0,mY=0;cn.forEach(c=>{const f=G(c.from),t=G(c.to);if(f&&t){const fr=gR(f),tr=gR(t),dr=gR(dZ);if(c.type==='h'||c.type==='u'){const pc=(c.type==='h')?(sT.includes(f.dataset.type)?f:t):(bT.slice(0,9).includes(f.dataset.type)?f:t),lc=(c.type==='h')?(f.dataset.type==='l1'?f:t):(f.dataset.type==='l2'?f:t),pr=gR(pc),lr=gR(lc),px=pr.right-dr[L]+2,py=(c.type==='h'?(pc.dataset.type==='s2'?pr[T]+pr.height*0.35-dr[T]:pc.dataset.type==='s1'?pr[T]+pr.height*0.4-dr[T]:pc.dataset.type==='s3'?pr[T]+pr.height*0.37-dr[T]:pr[T]+pr.height/2-dr[T]):pr[T]+pr.height/2-dr[T]-20),lx=lr[L]-dr[L]+10;mX=M.max(mX,px,lx+100);mY=M.max(mY,py+60);const g=D.createElementNS(H,'g'),l=D.createElementNS(H,'line');[['x1',px],['y1',py],['x2',lx],['y2',py],['stroke','#2c3e50'],['stroke-width','3']].forEach(([k,v])=>l.setAttribute(k,v));const bh=(c.type==='h'?(['s1','s2'].includes(pc.dataset.type)?30:50):40),bv=D.createElementNS(H,'line');[['x1',px],['y1',py-bh],['x2',px],['y2',py+bh],['stroke','#2c3e50'],['stroke-width','3']].forEach(([k,v])=>bv.setAttribute(k,v));const bt=D.createElementNS(H,'line');[['x1',px],['y1',py-bh],['x2',px-8],['y2',py-bh],['stroke','#2c3e50'],['stroke-width','3']].forEach(([k,v])=>bt.setAttribute(k,v));const bb=D.createElementNS(H,'line');[['x1',px],['y1',py+bh],['x2',px-8],['y2',py+bh],['stroke','#2c3e50'],['stroke-width','3']].forEach(([k,v])=>bb.setAttribute(k,v));g.appendChild(bv);g.appendChild(bt);g.appendChild(bb);g.appendChild(l);s.appendChild(g)}else if(c.type==='t'){const a=aT.includes(f.dataset.type)?f:t,sp=sT.includes(f.dataset.type)?f:t,ar=gR(a),sr=gR(sp),si=sp.querySelector(E),sir=si?gR(si):sr,ax=ar.right-dr[L],ay=ar[T]+ar.height/2-dr[T],sx=sir[L]-dr[L],sy=sr[T]-dr[T]+(sp.dataset.type==='s3'||sp.dataset.type==='s1'?35:55);mX=M.max(mX,ax,sx);mY=M.max(mY,ay,sy);if(M.abs(ay-sy)<5){const l=D.createElementNS(H,'line');[['x1',ax],['y1',ay],['x2',sx],['y2',ay],['stroke','#09c'],['stroke-width','3']].forEach(([k,v])=>l.setAttribute(k,v));s.appendChild(l)}else{const g=D.createElementNS(H,'g'),mx=ax+(sx-ax)/2,l1=D.createElementNS(H,'line'),l2=D.createElementNS(H,'line'),l3=D.createElementNS(H,'line');[['x1',ax],['y1',ay],['x2',mx],['y2',ay],['stroke','#09c'],['stroke-width','3']].forEach(([k,v])=>l1.setAttribute(k,v));[['x1',mx],['y1',ay],['x2',mx],['y2',sy],['stroke','#09c'],['stroke-width','3']].forEach(([k,v])=>l2.setAttribute(k,v));[['x1',mx],['y1',sy],['x2',sx],['y2',sy],['stroke','#09c'],['stroke-width','3']].forEach(([k,v])=>l3.setAttribute(k,v));g.appendChild(l1);g.appendChild(l2);g.appendChild(l3);s.appendChild(g)}}else{let x1=fr[L]+fr.width/2-dr[L],y1=fr[T]+fr.height/2-dr[T],x2=tr[L]+tr.width/2-dr[L],y2=tr[T]+tr.height/2-dr[T];

const fIsGrid=f.dataset.type==='grid',tIsGrid=t.dataset.type==='grid';
if(fIsGrid){const fi=f.querySelector(E);if(fi){const fir=gR(fi);y1=fir[T]+fir.height/2-dr[T]}}
if(tIsGrid){const ti=t.querySelector(E);if(ti){const tir=gR(ti);y2=tir[T]+tir.height/2-dr[T]}}

const fIsM=mT.includes(f.dataset.type),tIsM=mT.includes(t.dataset.type),fIsP=[...sT,'p1','p3','p2'].includes(f.dataset.type),tIsP=[...sT,'p1','p3','p2'].includes(t.dataset.type);const fIsA=aT.includes(f.dataset.type),tIsA=aT.includes(t.dataset.type);mX=M.max(mX,x1,x2);mY=M.max(mY,y1,y2);if(fIsM&&tIsP){const fi=f.querySelector(E),fir=fi?gR(fi):fr;x1=fir[L]+fir.width/2-dr[L];y1=fir[T]+fir.height/2-dr[T];x2=tr[L]+tr.width/2-dr[L];y2=tr[T]-dr[T]+(t.dataset.type==='s3'||t.dataset.type==='s1'?35:55)}else if(tIsM&&fIsP){const ti=t.querySelector(E),tir=ti?gR(ti):tr;x2=tir[L]+tir.width/2-dr[L];y2=tir[T]+tir.height/2-dr[T];x1=fr[L]+fr.width/2-dr[L];y1=fr[T]-dr[T]+(f.dataset.type==='s3'||f.dataset.type==='s1'?35:55)}if(fIsM&&tIsA){const fi=f.querySelector(E),fir=fi?gR(fi):fr;x1=fir[L]+fir.width/2-dr[L];y1=fir[T]+fir.height/2-dr[T];x2=tr[L]+tr.width/2-dr[L];y2=tr[T]+tr.height/4-dr[T]}else if(tIsM&&fIsA){const ti=t.querySelector(E),tir=ti?gR(ti):tr;x2=tir[L]+tir.width/2-dr[L];y2=tir[T]+tir.height/2-dr[T];x1=fr[L]+fr.width/2-dr[L];y1=fr[T]+tr.height/4-dr[T]}else if(fIsA&&tIsP){x1=fr[L]+fr.width/2-dr[L];y1=fr[T]+fr.height/2-dr[T];x2=tr[L]+tr.width/2-dr[L];y2=tr[T]-dr[T]+(t.dataset.type==='s3'||t.dataset.type==='s1'?35:55)}const fIsNonSpan=['p1','p2'].includes(f.dataset.type),tIsNonSpan=['p1','p2'].includes(t.dataset.type),fIsSpan=sT.includes(f.dataset.type),tIsSpan=sT.includes(t.dataset.type);if(fIsNonSpan&&tIsSpan){x1=fr[L]+fr.width/2-dr[L];y1=fr[T]+fr.height/2-dr[T];x2=tr[L]+tr.width/2-dr[L];y2=tr[T]+tr.height*0.75-dr[T]}else if(tIsNonSpan&&fIsSpan){x2=tr[L]+tr.width/2-dr[L];y2=tr[T]+tr.height/2-dr[T];x1=fr[L]+fr.width/2-dr[L];y1=fr[T]+fr.height*0.75-dr[T]}const fIsSolar=f.dataset.type==='solar',tIsSolar=t.dataset.type==='solar';if(fIsSolar&&tIsSpan){x1=fr[L]+fr.width/2-dr[L];y1=fr[T]+fr.height/2-dr[T];x2=tr[L]+tr.width/2-dr[L];const solarY=t.dataset.type==='s1'?0.6:t.dataset.type==='s2'?0.55:t.dataset.type==='s3'?0.75:t.dataset.type==='s4'?0.75:t.dataset.type==='s5'?0.75:0.4;y2=tr[T]+tr.height*solarY-dr[T]}else if(tIsSolar&&fIsSpan){x2=tr[L]+tr.width/2-dr[L];y2=tr[T]+tr.height/2-dr[T];x1=fr[L]+fr.width/2-dr[L];const solarY=f.dataset.type==='s1'?0.6:f.dataset.type==='s2'?0.55:f.dataset.type==='s3'?0.75:f.dataset.type==='s4'?0.75:f.dataset.type==='s5'?0.75:0.4;y1=fr[T]+fr.height*solarY-dr[T]}if(f.dataset.type==='rm')y1=fr[T]+20-dr[T];if(t.dataset.type==='rm')y2=tr[T]+20-dr[T];
const fIsRM=f.dataset.type==='rm',tIsRM=t.dataset.type==='rm';if(fIsRM&&tIsSpan){x2=tr[L]+tr.width/2-dr[L];y2=tr[T]+tr.height*0.65-dr[T]}else if(tIsRM&&fIsSpan){x1=fr[L]+fr.width/2-dr[L];y1=fr[T]+fr.height*0.65-dr[T]}
const fIsDrive=f.dataset.type==='e1',tIsDrive=t.dataset.type==='e1';if(fIsDrive&&sT.includes(t.dataset.type)&&(t.dataset.type==='s3'||t.dataset.type==='s4')){x1=fr[L]+fr.width/2-dr[L];y1=fr[T]+fr.height/2-dr[T];x2=tr[L]+tr.width/2-dr[L];y2=tr[T]+tr.height*0.65-dr[T]}else if(tIsDrive&&sT.includes(f.dataset.type)&&(f.dataset.type==='s3'||f.dataset.type==='s4')){x2=tr[L]+tr.width/2-dr[L];y2=tr[T]+tr.height/2-dr[T];x1=fr[L]+fr.width/2-dr[L];y1=fr[T]+fr.height*0.65-dr[T]}const fIsGW=gT.includes(f.dataset.type),tIsGW=gT.includes(t.dataset.type),fIsBat=f.dataset.type==='battery',tIsBat=t.dataset.type==='battery';if(fIsGW&&tIsBat){const fi=f.querySelector(E),fir=fi?gR(fi):fr;y1=fir[T]+fir.height*0.8-dr[T]}else if(tIsGW&&fIsBat){const ti=t.querySelector(E),tir=ti?gR(ti):tr;y2=tir[T]+tir.height*0.8-dr[T]}if(f.dataset.type==='m2')y1=fr[T]+fr.height*0.6-dr[T];if(t.dataset.type==='m2')y2=tr[T]+tr.height*0.3-dr[T];const l=D.createElementNS(H,'line');if(M.abs(y1-y2)<5)[['x1',x1],['y1',y1],['x2',x2],['y2',y1],['stroke','#3498db'],['stroke-width','3']].forEach(([k,v])=>l.setAttribute(k,v));else{const mx=x1+(x2-x1)/2;[['x1',x1],['y1',y1],['x2',mx],['y2',y1],['stroke','#3498db'],['stroke-width','3']].forEach(([k,v])=>l.setAttribute(k,v));s.appendChild(l);const l2=D.createElementNS(H,'line'),l3=D.createElementNS(H,'line');[['x1',mx],['y1',y1],['x2',mx],['y2',y2],['stroke','#3498db'],['stroke-width','3']].forEach(([k,v])=>l2.setAttribute(k,v));[['x1',mx],['y1',y2],['x2',x2],['y2',y2],['stroke','#3498db'],['stroke-width','3']].forEach(([k,v])=>l3.setAttribute(k,v));s.appendChild(l2);s.appendChild(l3);return}s.appendChild(l)}}});if(mX>0||mY>0){s[S].width=M.max(dZ.clientWidth,mX+50)+'px';s[S].height=M.max(dZ.clientHeight,mY+50)+'px'}}
function tCM(){cM=!cM;const b=G('cB'),m=G('mI');if(cM){b.textContent='Move Mode';b.classList.remove('active');m.textContent='Connect Mode - Click components to connect';m.classList.add('active');if(fS){fS.classList.remove('connecting');fS=null}}else{b.textContent='Connect Mode';b.classList.remove('active');m.textContent='Move Mode';m.classList.add('active');QA('.d.connecting').forEach(c=>c.classList.remove('connecting'));fS=null}}
function rC(id){const c=G(id);if(c){if(aT.includes(c.dataset.type)){const cId=cn.filter(n=>(n.from===id||n.to===id)&&n.type==='n').map(n=>n.from===id?n.to:n.from);cId.forEach(ci=>{const cc=G(ci);if(cc&&(cc.dataset.type==='gen'||cc.dataset.type==='m1')){const oC=cn.filter(n=>((n.from===ci||n.to===ci)&&(n.from!==id&&n.to!==id)));if(oC.length===0){cc.remove();dC=dC.filter(x=>x.id!==ci);cn=cn.filter(x=>x.from!==ci&&x.to!==ci)}}})}c.remove();dC=dC.filter(x=>x.id!==id);cn=cn.filter(x=>x.from!==id&&x.to!==id);uC();uDZS();if(dC.length===0)Q('.dzt')[S].display=B}}
function cCn(){cn=[];uC();uDZS()}
async function shareConfig(){if(dC.length===0){alert('Add components first');return}const lm=CE('div');lm[S].cssText=`${P}:fixed;${T}:50%;${L}:50%;transform:translate(-50%,-50%);background:#2c3e50;color:#fff;padding:20px;border-radius:8px;z-index:10000`;lm.textContent='Preparing diagram...';D.body.appendChild(lm);const rb=QA('.r');rb.forEach(b=>b[S].display=N);try{const cv=CE('canvas'),ctx=cv.getContext('2d'),r=gR(dZ),p=40,sc=2;let mnX=r.width,mnY=r.height,mX=0,mY=0;QA(Z).forEach(c=>{const cr=gR(c),x=cr[L]-r[L],y=cr[T]-r[T];mnX=M.min(mnX,x-10);mnY=M.min(mnY,y-10);mX=M.max(mX,x+cr.width+10);mY=M.max(mY,y+cr.height+10)});const cw=M.max(r.width,mX-mnX+p*2),ch=M.max(r.height,mY-mnY+p*2+50);cv.width=cw*sc;cv.height=ch*sc;ctx.scale(sc,sc);ctx.translate(p-mnX,p-mnY);ctx.fillStyle='#fff';ctx.fillRect(mnX-p,mnY-p,cw,ch);ctx.strokeStyle='#bdc3c7';ctx.lineWidth=3;ctx.setLineDash([10,10]);ctx.strokeRect(0,0,r.width,r.height);ctx.setLineDash([]);cn.forEach(c=>{const f=G(c.from),t=G(c.to);if(f&&t){const fr=gR(f),tr=gR(t);if(c.type==='h'||c.type==='u'){const pe=(c.type==='h')?(sT.includes(f.dataset.type)?f:t):(bT.slice(0,9).includes(f.dataset.type)?f:t),le=(c.type==='h')?(f.dataset.type==='l1'?f:t):(f.dataset.type==='l2'?f:t),pr=gR(pe),lr=gR(le),pi=pe.querySelector(E),pir=pi?gR(pi):pr;let ho,px,lx;ho=bT.slice(0,9).includes(pe.dataset.type)?8:-5;px=pir.right-r[L]+ho;lx=lr[L]-r[L];let py=(c.type==='h'?(pe.dataset.type==='s2'?pr[T]+pr.height/2-r[T]-20:pr[T]+pr.height/2-r[T]):pr[T]+pr.height/2-r[T]-20);ctx.strokeStyle='#2c3e50';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(px,py);ctx.lineTo(lx,py);ctx.stroke();const bh=(c.type==='h'?(['s1','s2'].includes(pe.dataset.type)?30:50):40);ctx.beginPath();ctx.moveTo(px,py-bh);ctx.lineTo(px,py+bh);ctx.stroke();ctx.beginPath();ctx.moveTo(px,py-bh);ctx.lineTo(px-8,py-bh);ctx.stroke();ctx.beginPath();ctx.moveTo(px,py+bh);ctx.lineTo(px-8,py+bh);ctx.stroke()}else if(c.type==='t'){const a=aT.includes(f.dataset.type)?f:t,sp=sT.includes(f.dataset.type)?f:t,ar=gR(a),sr=gR(sp),si=sp.querySelector(E),sir=si?gR(si):sr,ax=ar.right-r[L],ay=ar[T]+ar.height/2-r[T],sx=sir[L]-r[L],sy=sr[T]+sr.height/2-r[T];ctx.strokeStyle='#09c';ctx.lineWidth=3;if(M.abs(ay-sy)<5){ctx.beginPath();ctx.moveTo(ax,ay);ctx.lineTo(sx,ay);ctx.stroke()}else{const mx=ax+(sx-ax)/2;ctx.beginPath();ctx.moveTo(ax,ay);ctx.lineTo(mx,ay);ctx.stroke();ctx.beginPath();ctx.moveTo(mx,ay);ctx.lineTo(mx,sy);ctx.stroke();ctx.beginPath();ctx.moveTo(mx,sy);ctx.lineTo(sx,sy);ctx.stroke()}}else{const fi=f.querySelector(E),ti=t.querySelector(E),fir=fi?gR(fi):fr,tir=ti?gR(ti):tr,x1=fir[L]+fir.width/2-r[L],y1=fir[T]+fir.height/2-r[T],x2=tir[L]+tir.width/2-r[L],y2=tir[T]+tir.height/2-r[T];ctx.strokeStyle='#3498db';ctx.lineWidth=3;if(M.abs(y1-y2)<5){ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y1);ctx.stroke()}else{const mx=x1+(x2-x1)/2;ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(mx,y1);ctx.stroke();ctx.beginPath();ctx.moveTo(mx,y1);ctx.lineTo(mx,y2);ctx.stroke();ctx.beginPath();ctx.moveTo(mx,y2);ctx.lineTo(x2,y2);ctx.stroke()}}}});const ip=[],cd=[];QA(Z).forEach(c=>{const cr=gR(c),x=cr[L]-r[L],y=cr[T]-r[T],t=c.dataset.type,is=cI[t],nt=c.querySelector('.n').textContent;if(is){const i=new Image();i.crossOrigin='anonymous';const pr=new Promise((rs,rj)=>{i.onload=()=>rs(i);i.onerror=rj});i.src=is;ip.push(pr);cd.push({id:c.id,x,y,width:cr.width,height:cr.height,type:t,name:nt,imgIndex:ip.length-1})}});const li=await Promise.all(ip);cd.forEach(c=>{const i=li[c.imgIndex],ce=G(c.id),ie=ce?ce.querySelector(E+' '+I):null,ir=ie?gR(ie):null;if(!sT.includes(c.type)&&!bT.concat(lT,'meter','ats').includes(c.type)){const is=50,bs=100;ctx.fillStyle='#e8f0fe';ctx.beginPath();ctx.arc(c.x+bs/2,c.y+bs/2,bs/2,0,M.PI*2);ctx.fill();ctx.drawImage(i,c.x+(bs-is)/2,c.y+(bs-is)/2,is,is)}else{if(ir){const ix=c.x+(c.width-ir.width)/2,iy=c.y;ctx.drawImage(i,ix,iy,ir.width,ir.height)}else{let iw,ih;if(['s1','s2'].includes(c.type)){iw=100;ih=180}else if(['s3','s4','s5'].includes(c.type)){iw=140;ih=240}else if(bT.includes(c.type)){iw=100;ih=140}else{iw=60;ih=60}const ix=c.x+(c.width-iw)/2,iy=c.y;ctx.drawImage(i,ix,iy,iw,ih)}}ctx.fillStyle='#2c3e50';ctx.font='bold 14px sans-serif';ctx.textAlign='center';const ls=c.name.replace(/<br>/g,'\n').replace(/[◄►]/g,'').trim().split('\n'),lh=18;let ty;if(ir){const ib=c.y+(ir.height||c.height);ty=ib+15}else{if(lT.includes(c.type))ty=c.y+75;else if(['s1','s2'].includes(c.type))ty=c.y+195;else if(['s3','s4','s5'].includes(c.type))ty=c.y+255;else if(bT.includes(c.type))ty=c.y+155;else if(['grid','solar','battery','gen'].includes(c.type))ty=c.y+120;else ty=c.y+140}ls.forEach((l,idx)=>ctx.fillText(l.trim(),c.x+c.width/2,ty+(idx*lh)))});

const disc=G('disclaimer'),pd=G('pd'),pn=G('pn');const spanLogo=new Image();spanLogo.crossOrigin='anonymous';spanLogo.src='https://cdn.prod.website-files.com/62e15afb0ead4bad92750d3a/62e15afb0ead4bcd05750e09_span-logo-r.svg';await new Promise(resolve=>{spanLogo.onload=resolve;spanLogo.onerror=resolve});function wrapText(text,maxWidth){const words=text.split(' ');const lines=[];let line='';for(let i=0;i<words.length;i++){const testLine=line+words[i]+' ';const metrics=ctx.measureText(testLine);if(metrics.width>maxWidth&&line!==''){lines.push(line);line=words[i]+' '}else{line=testLine}}lines.push(line);return lines}const discText='This tool is intended as a preliminary guide only. You are responsible for ensuring your final product selection meets local code requirements and aligns with your customer\'s specific needs. If you have any questions, please contact your SPAN sales representative or email support@span.io';const discLines=wrapText(discText,310);let pdLines=[],noteLines=[];if(pd){const ta=pd.querySelector('textarea'),txt=ta.value;if(txt){ctx.font='11px sans-serif';pdLines=wrapText(txt,240)}}if(pn){const ta=pn.querySelector('textarea'),txt=ta.value;if(txt){ctx.font='11px sans-serif';noteLines=wrapText(txt,cw-530)}}const baseBoxY=ch-170-mnY+p;const discHeight=Math.max(150,discLines.length*10+40);const pdHeight=Math.max(150,pdLines.length*12+50);const noteWidth=cw-530;const noteHeight=Math.max(150,noteLines.length*12+50);const pdExtraHeight=Math.max(0,pdHeight-150);const noteExtraHeight=Math.max(0,noteHeight-150);const pdBoxY=baseBoxY-pdExtraHeight;const noteBoxY=baseBoxY-noteExtraHeight;ctx.fillStyle='#fff';ctx.fillRect(20-mnX+p,baseBoxY,200,discHeight);ctx.strokeStyle='#2c3e50';ctx.lineWidth=2;ctx.strokeRect(20-mnX+p,baseBoxY,200,discHeight);ctx.drawImage(spanLogo,25-mnX+p,baseBoxY+8,150,20);ctx.fillStyle='#2c3e50';ctx.font='9px sans-serif';ctx.textAlign='left';discLines.forEach((line,i)=>ctx.fillText(line.trim(),25-mnX+p,baseBoxY+40+i*14));ctx.fillStyle='#fff';ctx.fillRect(240-mnX+p,pdBoxY,250,pdHeight);ctx.strokeStyle='#2c3e50';ctx.lineWidth=2;ctx.strokeRect(240-mnX+p,pdBoxY,250,pdHeight);ctx.fillStyle='#2c3e50';ctx.font='bold 12px sans-serif';ctx.fillText('Project Details',245-mnX+p,pdBoxY+15);if(pdLines.length>0){ctx.font='11px sans-serif';pdLines.forEach((line,i)=>ctx.fillText(line.trim(),245-mnX+p,pdBoxY+35+i*12))}ctx.fillStyle='#fff';ctx.fillRect(510-mnX+p,noteBoxY,noteWidth,noteHeight);ctx.strokeStyle='#2c3e50';ctx.lineWidth=2;ctx.strokeRect(510-mnX+p,noteBoxY,noteWidth,noteHeight);ctx.fillStyle='#2c3e50';ctx.font='bold 12px sans-serif';ctx.fillText('Notes',515-mnX+p,noteBoxY+15);if(noteLines.length>0){ctx.font='11px sans-serif';noteLines.forEach((line,i)=>ctx.fillText(line.trim(),515-mnX+p,noteBoxY+35+i*12))}

D.body.removeChild(lm);rb.forEach(b=>b[S].display='flex');cv.toBlob(bl=>{const u=URL.createObjectURL(bl),a=CE('a');a.href=u;a.download='span-diagram.png';a.click();URL.revokeObjectURL(u);alert('Diagram downloaded!')},'image/png')}catch(err){console.error('Error:',err);if(lm.parentNode)D.body.removeChild(lm);rb.forEach(b=>b[S].display='flex');alert('Error - use screenshot tool.')}}

function gUP(){const p=new URLSearchParams(W.location.search),r={};['upgrade','monitoring','battery','batteryType','meterCombo','circuits','recommendation','configuration','panelType','panelOutOfDate','upstreamWork','voltage'].forEach(k=>r[k]=p.get(k));return r}
function cRP(){const p=gUP(),r='ri',s='<div class="'+r+'"><strong>',e='</strong> ',c='</span></div>',y='yes',n='no';if(!p.recommendation&&!p.upgrade&&!p.monitoring&&!p.battery)return;Q('.rp')?.remove();const d=CE('div');d.className='rp';d.innerHTML='<h3>Panel Picker</h3><button class="cr" onclick="this.parentElement.remove()">×</button>'+(p.recommendation?s+'Rec:'+e+p.recommendation+'</div>':'')+(p.configuration?s+'Config:'+e+p.configuration+'</div>':'')+(p.upgrade?s+'Upgrade:'+e+'<span class="'+(p.upgrade==='Yes'?y:n)+'">'+p.upgrade+c:'')+(p.monitoring?s+'Monitor:'+e+'<span class="'+(p.monitoring==='Yes'?y:n)+'">'+p.monitoring+c:'')+(p.battery?s+'Battery:'+e+'<span class="'+(p.battery==='Yes'?y:n)+'">'+p.battery+c+(p.battery==='Yes'&&p.batteryType?s+'Type:'+e+p.batteryType+'</div>':''):'')+(p.meterCombo?s+'Meter Combo:'+e+'<span class="'+(p.meterCombo==='Yes'?y:n)+'">'+p.meterCombo+c:'')+(p.circuits?s+'Circuits:'+e+p.circuits+'</div>':'')+(p.voltage?s+'Voltage:'+e+p.voltage+'</div>':'')+(p.panelType?s+'Type:'+e+(p.panelType==='main'?'Main':'Sub')+'</div>':'')+(p.panelOutOfDate?s+'Out of Date:'+e+'<span class="'+(p.panelOutOfDate==='Yes'?y:n)+'">'+p.panelOutOfDate+c:'')+(p.upstreamWork?s+'Upstream:'+e+'<span class="'+(p.upstreamWork==='Yes'?y:n)+'">'+p.upstreamWork+c:'');D.body.appendChild(d)}
function aLD(){const p=gUP();if(!p.recommendation)return;setTimeout(()=>{const cps=[];let x=100,y=200,sp=null;if(p.recommendation){const pn=p.recommendation.toUpperCase();sp=pn.includes('MLO 48')?{t:'s5',n:'SPAN MLO 48'}:pn.includes('MLO 24')?{t:'s2',n:'SPAN MLO 24'}:pn.includes('MAIN 40')?{t:'s4',n:'SPAN MAIN 40'}:pn.includes('MAIN 32')?{t:'s3',n:'SPAN MAIN 32'}:pn.includes('MAIN 16')?{t:'s1',n:'SPAN MAIN 16'}:null}if(p.panelType==='sub'){cps.push({t:'grid',n:'Grid 200A',x:x,y:y-100});if(p.meterCombo==='Yes'){cps.push({t:'m1',n:'Meter Main',x:x+200,y},{t:'p1',n:'Main Panel',x:x+400,y});x+=400}else{cps.push({t:'meter',n:'Meter',x:x+120,y:y-95},{t:'p4',n:'Main Disconnect',x:x+210,y:y-40});x+=400;if(p.battery!=='Yes')cps.push({t:'p3',n:'M.I.D.',x:x+100,y})}}else if(p.meterCombo==='Yes'){cps.push({t:'grid',n:'Grid 200A',x:x,y:y-100},{t:'m1',n:'Meter Main',x:x+200,y});x+=400;}else{cps.push({t:'grid',n:'Grid 200A',x:x,y:y-100},{t:'meter',n:'Meter',x:x+120,y:y-80},{t:'p4',n:'Main Disconnect',x:x+230,y});x+=230}
const b=p.batteryType&&p.batteryType.toLowerCase();
if(sp){sp.x=x+150;sp.y=y;if(sp.t==='s2'){sp.x=sp.x-20}if(p.panelType==='main'&&sp?.t==='s1'&&p.meterCombo==='No'&&b&&b.includes('franklin')){sp.x=x+350}if(p.panelType==='main'&&sp?.t==='s1'&&p.meterCombo==='No'&&b&&(b.includes('tesla')||b.includes('powerwall'))){sp.x=x+300}if(sp?.t==='s3'&&p.meterCombo==='No'&&b&&(b.includes('tesla')||b.includes('powerwall'))){sp.x=x+310}if(sp?.t==='s3'&&p.meterCombo==='No'&&b&&b.includes('enphase')){sp.x=x+250}if(p.panelType==='main'&&sp?.t==='s4'&&p.meterCombo==='No'&&b&&(b.includes('tesla')||b.includes('powerwall'))){sp.x=x+350}cps.push(sp);cps.push({t:'l1',n:'House Loads',x:sp.x+140,y:sp.y+60})}if(p.battery==='Yes'){if(b&&(b.includes('tesla')||b.includes('powerwall'))){if(p.panelType==='sub'&&sp?.t==='s2'&&p.meterCombo==='No'){cps.push({t:'gw3',n:'Tesla Gateway',x:x-50,y:y+40},{t:'battery',n:'Battery',x:x-60,y:y+180})}else if(sp?.t==='s3'&&p.meterCombo==='No'){cps.push({t:'gw3',n:'Tesla Gateway',x:x+160,y:y},{t:'battery',n:'Battery',x:x+150,y:y+180})}else if(p.panelType==='sub'&&sp?.t==='s2'&&p.meterCombo==='Yes'){cps.push({t:'gw3',n:'Tesla Gateway',x:x-120,y:y+150},{t:'battery',n:'Battery',x:x-200,y:y+150})}else if(sp?.t==='s2'&&p.meterCombo==='Yes'){cps.push({t:'gw3',n:'Tesla Gateway',x:x-30,y:y+150},{t:'battery',n:'Battery',x:x,y:y+270})}else if(sp?.t==='s5'&&p.meterCombo==='Yes'){cps.push({t:'gw3',n:'Tesla Gateway',x:x+25,y:y+150},{t:'battery',n:'Battery',x:x+25,y:y+290})}else if(sp?.t==='s3'&&p.meterCombo==='Yes'){cps.push({t:'gw3',n:'Tesla Gateway',x:x+15,y:y+150},{t:'battery',n:'Battery',x:x+15,y:y+290})}else{cps.push({t:'gw3',n:'Tesla Gateway',x:x+200,y:y+150},{t:'battery',n:'Battery',x:x,y:y+150})}}else if(b&&b.includes('enphase')){if(sp?.t==='s3'&&p.meterCombo==='No'){cps.push({t:'gw1',n:'Enphase Controller',x:x-100,y:y+200},{t:'battery',n:'Battery',x:x-100,y:y+380},{t:'rm',n:'SPAN Remote Meter Kit',x:x,y:y+100})}else{cps.push({t:'gw1',n:'Enphase Controller',x:x,y:y+250},{t:'battery',n:'Battery',x:x,y:y+430},{t:'rm',n:'SPAN Remote Meter Kit',x:x+100,y:y+150})}}else if(b&&b.includes('franklin')){if(p.panelType==='main'&&sp?.t==='s1'&&p.meterCombo==='No'){cps.push({t:'gw2',n:'Franklin aGate',x:x+200,y:y+40},{t:'battery',n:'Battery',x:x+190,y:y+180})}else if(sp?.t==='s2'&&p.meterCombo==='Yes'){cps.push({t:'gw2',n:'Franklin aGate',x:x-10,y:y+200},{t:'battery',n:'Battery',x:x-10,y:y+340})}else if(p.panelType==='main'&&sp?.t==='s4'&&p.meterCombo==='No'){cps.push({t:'gw2',n:'Franklin aGate',x:x-10,y:y+190},{t:'battery',n:'Battery',x:x-10,y:y+330})}else{cps.push({t:'gw2',n:'Franklin aGate',x:x-10,y:y+40},{t:'battery',n:'Battery',x:x-10,y:y+180})}}else if(b&&b.includes('solaredge'))cps.push({t:'gw4',n:'SolarEdge Gateway',x:x,y:y+200},{t:'battery',n:'Battery',x:x,y:y+380})}cps.forEach(c=>{const el=QA('.c[data-type="'+c.t+'"]')[0];if(el)cDC(el,c.x,c.y)});setTimeout(()=>{const f=(t)=>Array.from(QA(Z)).find(e=>e.dataset.type===t);if(p.panelType==='sub'){if(p.meterCombo==='Yes'){const g=f('grid'),mt=f('m1'),mp=f('p1'),s=f(sp?.t);if(g&&mt)cC(g,mt);if(mt&&mp)cC(mt,mp);if(mp&&s)cC(mp,s)}else{const g=f('grid'),m=f('meter'),md=f('p4'),mid=f('p3'),s=f(sp?.t);if(g&&m)cC(g,m);if(m&&md)cC(m,md);if(p.battery==='Yes'){const gw=f('gw3')||f('gw2')||f('gw4')||f('gw1');if(md&&gw&&gw.dataset.type!=='gw1')cC(md,gw);if(gw&&s&&gw.dataset.type!=='gw1')cC(gw,s)}else if(md&&mid)cC(md,mid);if(mid&&s)cC(mid,s)}}else{const g=f('grid'),mt=f('m1'),m=f('meter'),md=f('p4'),s=f(sp?.t);if(g&&mt)cC(g,mt);if(mt&&s)cC(mt,s);if(g&&m)cC(g,m);if(m&&md)cC(m,md);if(p.battery==='Yes'){const gw=f('gw3')||f('gw2')||f('gw4')||f('gw1');if(md&&gw&&gw.dataset.type!=='gw1')cC(md,gw);if(gw&&s&&gw.dataset.type!=='gw1')cC(gw,s);if(md&&s&&gw.dataset.type==='gw1')cC(md,s)}else if(md&&s)cC(md,s)}const gw=f('gw3')||f('gw2')||f('gw4')||f('gw1'),bt=f('battery'),hl=f('l1'),s=f(sp?.t),rm=f('rm');if(gw&&bt)cC(gw,bt);if(gw&&rm)cC(gw,rm);if(rm&&s)cC(rm,s);if(hl&&s)cC(s,hl)},200);setTimeout(()=>sN(G('c1'),'Auto-generated diagram','#0c0'),500);cRP()},100)}
AE(W,'load',()=>{let h='';
h+=gCH('Power Sources');
[['grid',0,'Grid'],['solar',1,'Solar'],['battery',2,'Battery'],['gen',3,'Generator']].forEach(([t,i,n,s])=>h+=gC(t,i,n,s));
h+=gCH('Meters & Monitoring');
[['meter',4,'Meter'],['m1',5,'Meter Main'],['p3',14,'M.I.D.']].forEach(([t,i,n,s])=>h+=gC(t,i,n,s));
h+=gCH('Panels & Distribution');
[['m2',6,'Main Service','Disconnect'],['p1',7,'Non-SPAN','Main'],['p2',8,'Non-SPAN','Sub'],['s1',9,'SPAN 16'],['s2',10,'SPAN 24'],['s3',11,'SPAN 32'],['s4',12,'SPAN 40'],['s5',13,'SPAN 48'],['p4',17,'Main Disconnect','(Ext)'],['ats',18,'ATS'],['mts',19,'MTS']].forEach(([t,i,n,s])=>h+=gC(t,i,n,s));
h+=gCH('Loads & Accessories');
[['l1',15,'House Loads'],['l2',15,'Upstream Loads'],['l3',15,'Garage Loads'],['l4',15,'ADU Loads'],['e1',16,'SPAN Drive'],['e2',16,'Other EVSE'],['rm',20,'Remote Meter Kit'],['gw1',21,'Enphase','IQ Controller'],['gw2',22,'Franklin aGate'],['gw3',23,'Tesla Gateway'],['gw4',24,'SolarEdge','Gateway']].forEach(([t,i,n,s])=>h+=gC(t,i,n,s));
G('cG').innerHTML=h;QA('.c').forEach(c=>AE(c,'dragstart',hDS));aLD()})
</script>
</body>
</html>